<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Onion Routing</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="onion_routing">Onion Routing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter we will describe the Lightning Network&#8217;s onion routing mechanism. The invention of <em>onion routing</em> precedes the Lightning Network by 25 years! Onion routing was invented by U.S. Navy researchers as a communications security protocol. Onion routing is most famously used by Tor, the onion-routed internet overlay that allows researchers, activists, intelligence agents, and everyone else to use the internet privately and anonymously.</p>
</div>
<div class="paragraph">
<p>In this chapter we are focusing on the "Source-based onion routing (SPHINX)" part of the Lightning protocol architecture, highlighted by an outline in the center (routing layer) of <a href="#LN_protocol_onion_highlight">Onion routing in the Lightning protocol suite</a>.</p>
</div>
<div id="LN_protocol_onion_highlight" class="imageblock">
<div class="content">
<img src="images/mtln_1001.png" alt="Onion routing in the Lightning protocol suite">
</div>
<div class="title">Figure 1. Onion routing in the Lightning protocol suite</div>
</div>
<div class="paragraph">
<p>Onion routing describes a method of encrypted communication where a message sender builds successive <em>nested layers of encryption</em> that are "peeled" off by each intermediary node, until the innermost layer is delivered to the intended recipient. The name "onion routing" describes this use of layered encryption that is peeled off one layer at a time, like the skin of an onion.</p>
</div>
<div class="paragraph">
<p>Each of the intermediary nodes can only "peel" one layer and see who is next in the communication path. Onion routing ensures that no one except the sender knows the destination or length of the communication path. Each intermediary only knows the previous and next hop.</p>
</div>
<div class="paragraph">
<p>The Lightning Network uses an implementation of onion routing protocol based on <em>Sphinx</em>,<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup> developed in 2009 by George Danezis and Ian Goldberg.</p>
</div>
<div class="paragraph">
<p>The implementation of onion routing in the Lightning Network is defined in <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/04-onion-routing.md">BOLT #4: Onion Routing Protocol</a>.</p>
</div>
<div class="sect2">
<h3 id="_a_physical_example_illustrating_onion_routing">A Physical Example Illustrating Onion Routing</h3>
<div class="paragraph">
<p>There are many ways to describe onion routing, but one of the easiest is to use the physical equivalent of sealed envelopes. An envelope represents a layer of encryption, allowing only the named recipient to open it and read the contents.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s say Alice wants to send a secret letter to Dina, indirectly via some intermediaries.</p>
</div>
<div class="sect3">
<h4 id="_selecting_a_path">Selecting a Path</h4>
<div class="paragraph">
<p>The Lightning Network uses <em>source routing</em>, which means that the payment path is selected and specified by the sender, and only the sender. In this example, Alice&#8217;s secret letter to Dina will be the equivalent of a payment. To make sure the letter reaches Dina, Alice will create a path from her to Dina, using Bob and Chan as intermediaries.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>There may be many paths that make it possible for Alice to reach Dina. We will explain the process of selecting the <em>optimum</em> path in <a href="#path_finding">[path_finding]</a>. For now, we&#8217;ll assume that the path selected by Alice uses Bob and Chan as intermediaries to get to Dina.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph pagebreak-before">
<p>As a reminder, the path selected by Alice is shown in <a href="#alice_dina_path">Path: Alice to Bob to Chan to Dina</a>.</p>
</div>
<div id="alice_dina_path" class="imageblock">
<div class="content">
<img src="images/mtln_1002.png" alt="Alice to Bob to Chan to Dina">
</div>
<div class="title">Figure 2. Path: Alice to Bob to Chan to Dina</div>
</div>
<div class="paragraph">
<p>Let&#8217;s see how Alice can use this path without revealing information to intermediaries Bob and Chan.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Source-Based Routing</div>
<div class="paragraph">
<p>Source-based routing is not how packets are typically routed on the internet today, though source routing was possible in the early days.
Internet routing is based on <em>packet switching</em> at each intermediary routing node. An IPv4 packet, for example, includes the sender and recipient&#8217;s IP addresses, and every other IP routing node decides how to forward each packet toward the destination.
However, the lack of privacy in such a routing mechanism, where every intermediary node sees the sender and recipient, makes this a poor choice for use in a payment network.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_building_the_layers">Building the Layers</h4>
<div class="paragraph">
<p>Alice starts by writing a secret letter to Dina.  She then seals the letter inside an envelope and writes "To Dina" on the outside (see <a href="#dina_envelope">Dina&#8217;s secret letter, sealed in an envelope</a>). The envelope represents encryption with Dina&#8217;s public key so that only Dina can open the envelope and read the letter.</p>
</div>
<div id="dina_envelope" class="imageblock">
<div class="content">
<img src="images/mtln_1003.png" alt="Dina&#8217;s secret letter, sealed in an envelope">
</div>
<div class="title">Figure 3. Dina&#8217;s secret letter, sealed in an envelope</div>
</div>
<div class="paragraph">
<p>Dina&#8217;s letter will be delivered to Dina by Chan, who is immediately before Dina in the "path." So, Alice puts Dina&#8217;s envelope inside an envelope addressed to Chan (see <a href="#chan_envelope">Chan&#8217;s envelope, containing Dina&#8217;s sealed envelope</a>). The only part that Chan can read is the destination (routing instructions): "To Dina." Sealing this inside an envelope addressed to Chan represents encrypting it with Chan&#8217;s public key so that only Chan can read the envelope address. Chan still can&#8217;t open Dina&#8217;s envelope. All he sees is the instructions on the outside (the address).</p>
</div>
<div id="chan_envelope" class="imageblock">
<div class="content">
<img src="images/mtln_1004.png" alt="Chan&#8217;s envelope, containing Dina&#8217;s sealed envelope">
</div>
<div class="title">Figure 4. Chan&#8217;s envelope, containing Dina&#8217;s sealed envelope</div>
</div>
<div class="paragraph">
<p>Now, this letter will be delivered to Chan by Bob. So Alice puts it inside an envelope addressed to Bob (see <a href="#bob_envelope">Bob&#8217;s envelope, containing Chan&#8217;s sealed envelope</a>). As before, the envelope represents a message encrypted to Bob that only Bob can read. Bob can only read the outside of Chan&#8217;s envelope (the address), so he knows to send it to Chan.</p>
</div>
<div id="bob_envelope" class="imageblock">
<div class="content">
<img src="images/mtln_1005.png" alt="Bob&#8217;s envelope, containing Chan&#8217;s sealed envelope">
</div>
<div class="title">Figure 5. Bob&#8217;s envelope, containing Chan&#8217;s sealed envelope</div>
</div>
<div class="paragraph">
<p>Now, if we could look through the envelopes (with X-rays!) we would see the envelopes nested one inside the other, as shown in <a href="#nested_envelopes">Nested envelopes</a>. </p>
</div>
<div id="nested_envelopes" class="imageblock">
<div class="content">
<img src="images/mtln_1006.png" alt="Nested envelopes">
</div>
<div class="title">Figure 6. Nested envelopes</div>
</div>
</div>
<div class="sect3">
<h4 id="_peeling_the_layers">Peeling the Layers</h4>
<div class="paragraph">
<p>Alice now has an envelope that says "To Bob" on the outside. It represents an encrypted message that only Bob can open (decrypt). Alice will now begin the process by sending this to Bob. The entire process is shown in <a href="#sending_nested_envelopes">Sending the envelopes</a>.</p>
</div>
<div id="sending_nested_envelopes" class="imageblock">
<div class="content">
<img src="images/mtln_1007.png" alt="Sending the envelopes">
</div>
<div class="title">Figure 7. Sending the envelopes</div>
</div>
<div class="paragraph">
<p>As you can see, Bob receives the envelope from Alice. He knows it came from Alice, but doesn&#8217;t know if Alice is the original sender or just someone forwarding envelopes. He opens it to find an envelope inside that says "To Chan." Since this is addressed to Chan, Bob can&#8217;t open it. He doesn&#8217;t know what&#8217;s inside it and doesn&#8217;t know if Chan is getting a letter or another envelope to forward. Bob doesn&#8217;t know if Chan is the ultimate recipient or not. Bob forwards the envelope to Chan.</p>
</div>
<div class="paragraph">
<p>Chan receives the envelope from Bob. He doesn&#8217;t know that it came from Alice. He doesn&#8217;t know if Bob is an intermediary or the sender of a letter. Chan opens the envelope and finds another envelope inside addressed "To Dina," which he can&#8217;t open. Chan forwards it to Dina, not knowing if Dina is the final recipient.</p>
</div>
<div class="paragraph">
<p>Dina receives an envelope from Chan. Opening it she finds a letter inside, so now she knows she&#8217;s the intended recipient of this message. She reads the letter, knowing that none of the intermediaries know where it came from and no one else has read her secret letter!</p>
</div>
<div class="paragraph">
<p>This is the essence of onion routing. The sender wraps a message in layers, specifying exactly how it will be routed and preventing any of the intermediaries from gaining any information about the path or payload. Each intermediary peels one layer, sees only a forwarding address, and doesn&#8217;t know anything other than the previous and next hop in the path.</p>
</div>
<div class="paragraph">
<p>Now, let&#8217;s look at the details of the onion routing implementation in the Lightning Network.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_introduction_to_onion_routing_of_htlcs">Introduction to Onion Routing of HTLCs</h3>
<div class="paragraph">
<p>Onion routing in the Lightning Network appears complex at first glance, but once you understand the basic concept, it is really quite simple.</p>
</div>
<div class="paragraph">
<p>From a practical perspective, Alice is telling every intermediary node what HTLC to set up with the next node in the path.</p>
</div>
<div class="paragraph">
<p>The first node, which is the payment sender or Alice in our example, is called the <em>origin node</em>.  The last node, which is the payment recipient or Dina in our example, is called the <em>final node</em>.</p>
</div>
<div class="paragraph">
<p>Each intermediary node, or Bob and Chan in our example, is called a <em>hop</em>. Every hop must set up an <em>outgoing HTLC</em> to the next hop. The information communicated to each hop by Alice is called the <em>hop payload</em> or <em>hop data</em>. The message that is routed from Alice to Dina is called an <em>onion</em> and consists of encrypted <em>hop payload</em> or <em>hop data</em> messages encrypted to each hop.</p>
</div>
<div class="paragraph">
<p>Now that we know the terminology used in Lightning onion routing, let&#8217;s restate Alice&#8217;s task: Alice must construct an onion with hop data, telling each hop how to construct an outgoing HTLC to send a payment to the final node (Dina).</p>
</div>
<div class="sect3">
<h4 id="_alice_selects_the_path">Alice Selects the Path</h4>
<div class="paragraph">
<p>From <a href="#routing">[routing]</a> we know that Alice will send a 50,000 satoshi payment to Dina via Bob and Chan. This payment is transmitted via a series of HTLCs, as shown in <a href="#alice_dina_htlc_path">Payment path with HTLCs from Alice to Dina</a>.</p>
</div>
<div id="alice_dina_htlc_path" class="imageblock">
<div class="content">
<img src="images/mtln_1008.png" alt="Payment path with HTLCs from Alice to Dina">
</div>
<div class="title">Figure 8. Payment path with HTLCs from Alice to Dina</div>
</div>
<div class="paragraph">
<p>As we will see in <a href="#gossip">[gossip]</a>, Alice is able to construct this path to Dina because Lightning nodes announce their channels to the entire Lightning Network using the Lightning Gossip Protocol. After the initial channel announcement, Bob and Chan each sent out an additional <code>channel_update</code> message with their routing fee and timelock expectations for payment routing.</p>
</div>
<div class="paragraph">
<p>From the announcements and updates, Alice knows the following information about the channels between Bob, Chan, and Dina:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A short_channel_id (short channel ID) for each channel, which Alice can use to reference the channel when constructing the path</p>
</li>
<li>
<p>A cltv_expiry_delta (timelock delta), which Alice can add to the expiry time for each HTLC</p>
</li>
<li>
<p>A fee_base_msat and fee_proportional_millionths, which Alice can use to calculate the total routing fee expected by that node for relay on that channel.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In practice, other information is also exchanged, such as the largest (<code>htlc_maximum_msat</code>) and smallest (<code>htlc_minimum_msat</code>) HTLCs a channel will carry, but these aren&#8217;t used as directly during onion route construction as the preceding fields are.</p>
</div>
<div class="paragraph">
<p>This information is used by Alice to identify the nodes, channels, fees, and timelocks for the following detailed path, shown in <a href="#alice_dina_path_detail">A detailed path constructed from gossiped channel and node information</a>.</p>
</div>
<div id="alice_dina_path_detail" class="imageblock">
<div class="content">
<img src="images/mtln_1009.png" alt="A path constructed from gossiped channel and node information">
</div>
<div class="title">Figure 9. A detailed path constructed from gossiped channel and node information</div>
</div>
<div class="paragraph">
<p>Alice already knows her own channel to Bob and therefore doesn&#8217;t need this info to construct the path. Note also that Alice didn&#8217;t need a channel update from Dina because she has the update from Chan for that last channel in the path.</p>
</div>
</div>
<div class="sect3">
<h4 id="_alice_constructs_the_payloads">Alice Constructs the Payloads</h4>
<div class="paragraph">
<p>There are two possible formats that Alice can use for the information communicated to each hop: a legacy fixed-length format called the <em>hop data</em> and a more flexible Type-Length-Value (TLV) based format called the <em>hop payload</em>. The TLV message format is explained in more detail in <a href="#tlv">[tlv]</a>. It offers flexibility by allowing fields to be added to the protocol at will.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Both formats are specified in <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/04-onion-routing.md#packet-structure">BOLT #4: Onion Routing Protocol, Packet Structure</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alice will start building the hop data from the end of the path backwards: Dina, Chan, then Bob.</p>
</div>
<div class="sect4">
<h5 id="_final_node_payload_for_dina">Final node payload for Dina</h5>
<div class="paragraph">
<p>Alice first builds the payload that will be delivered to Dina. Dina will not be constructing an "outgoing HTLC," because Dina is the final node and payment recipient. For this reason, the payload for Dina is different than all the others (uses all zeros for the <code>short_channel_id</code>), but only Dina will know this because it will be encrypted in the innermost layer of the onion. Essentially, this is the "secret letter to Dina" we saw in our physical envelope example.</p>
</div>
<div class="paragraph">
<p>The hop payload for Dina must match the information in the invoice generated by Dina for Alice and will contain (at least) the following fields in TLV format:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">amt_to_forward</dt>
<dd>
<p>The amount of this payment in millisatoshis. If this is only one part of a multipart payment, the amount is less than the total. Otherwise, this is a single, full payment and it is equal to the invoice amount and total_msat value.</p>
</dd>
<dt class="hdlist1">outgoing_cltv_value</dt>
<dd>
<p>The payment expiry timelock set to the value min_final_cltv_expiry in the invoice.</p>
</dd>
<dt class="hdlist1">payment_secret</dt>
<dd>
<p>A special 256-bit secret value from the invoice, allowing Dina to recognize this incoming payment. This also prevents a class of probing that previously made zero-value invoices insecure. Probing by intermediate nodes is mitigated as this value is encrypted to <em>only</em> the recipient, meaning they can&#8217;t reconstruct a final packet that "looks" legitimate.</p>
</dd>
<dt class="hdlist1">total_msat</dt>
<dd>
<p>The total amount matching the invoice. This may be omitted if there is only one part, in which case it is assumed to match amt_to_forward and must equal the invoice amount.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The invoice Alice received from Dina specified the amount as 50,000 satoshis, which is 50,000,000 millisatoshis. Dina specified the minimum expiry for the payment min_final_cltv_expiry as 18 blocks (3 hours, given 10-minute on average Bitcoin blocks). At the time Alice is attempting to make the payment, let&#8217;s say the Bitcoin blockchain has recorded 700,000 blocks. So Alice must set the outgoing_cltv_value to a <em>minimum</em> block height of 700,018.</p>
</div>
<div class="paragraph">
<p>Alice constructs the hop payload for Dina as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>amt_to_forward : 50,000,000
outgoing_cltv_value: 700,018
payment_secret: fb53d94b7b65580f75b98f10...03521bdab6d519143cd521d1b3826
total_msat: 50,000,000</pre>
</div>
</div>
<div class="paragraph">
<p>Alice serializes it in TLV format, as shown (simplified) in <a href="#dina_onion_payload">Dina&#8217;s payload is constructed by Alice</a>.</p>
</div>
<div id="dina_onion_payload" class="imageblock">
<div class="content">
<img src="images/mtln_1010.png" alt="Dina&#8217;s payload is constructed by Alice">
</div>
<div class="title">Figure 10. Dina&#8217;s payload is constructed by Alice</div>
</div>
</div>
<div class="sect4">
<h5 id="_hop_payload_for_chan">Hop payload for Chan</h5>
<div class="paragraph">
<p>Next, Alice constructs the hop payload for Chan. This will tell Chan how to set up an outgoing HTLC to Dina.</p>
</div>
<div class="paragraph">
<p>The hop payload for Chan includes three fields: short_channel_id, amt_to_forward, and outgoing_cltv_value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>short_channel_id: 010002010a42be
amt_to_forward: 50,000,000
outgoing_cltv_value: 700,018</pre>
</div>
</div>
<div class="paragraph">
<p>Alice serializes this payload in TLV format, as shown (simplified) in <a href="#chan_onion_payload">Chan&#8217;s payload is constructed by Alice</a>.</p>
</div>
<div id="chan_onion_payload" class="imageblock">
<div class="content">
<img src="images/mtln_1011.png" alt="Chan&#8217;s payload is constructed by Alice">
</div>
<div class="title">Figure 11. Chan&#8217;s payload is constructed by Alice</div>
</div>
</div>
<div class="sect4">
<h5 id="_hop_payload_for_bob">Hop payload for Bob</h5>
<div class="paragraph">
<p>Finally, Alice constructs the hop payload for Bob, which also contains the same three fields as the hop payload for Chan, but with different values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>short_channel_id: 000004040a61f0
amt_to_forward: 50,100,000
outgoing_cltv_value: 700,038</pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, the amt_to_forward field is 50,100,000 millisatoshis, or 50,100 satoshis. That&#8217;s because Chan expects a fee of 100 satoshis to route a payment to Dina. In order for Chan to "earn" that routing fee, Chan&#8217;s incoming HTLC must be 100 satoshis more than Chan&#8217;s outgoing HTLC. Since Chan&#8217;s incoming HTLC is Bob&#8217;s outgoing HTLC, the instructions to Bob reflect the fee Chan earns. In simple terms, Bob needs to be told to send 50,100 satoshi to Chan, so that Chan can send 50,000 satoshi and keep 100 satoshi.</p>
</div>
<div class="paragraph">
<p>Similarly, Chan expects a timelock delta of 20 blocks. So Chan&#8217;s incoming HTLC must expire 20 blocks <em>later</em> than Chan&#8217;s outgoing HTLC. To achieve this, Alice tells Bob to make his outgoing HTLC to Chan expire at block height 700,038-20 blocks later than Chan&#8217;s HTLC to Dina.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>Fees and timelock delta expectations for a channel are set by the difference between incoming and outgoing HTLCs. Since the incoming HTLC is created by the <em>preceding node</em>, the fee and timelock delta is set in the onion payload to that preceding node. Bob is told how to make an HTLC that meets Chan&#8217;s fee and timelock expectations.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alice serializes this payload in TLV format, as shown (simplified) in <a href="#bob_onion_payload">Bob&#8217;s payload is constructed by Alice</a>.</p>
</div>
<div id="bob_onion_payload" class="imageblock">
<div class="content">
<img src="images/mtln_1012.png" alt="Bob&#8217;s payload is constructed by Alice">
</div>
<div class="title">Figure 12. Bob&#8217;s payload is constructed by Alice</div>
</div>
</div>
<div class="sect4">
<h5 id="_finished_hop_payloads">Finished hop payloads</h5>
<div class="paragraph">
<p>Alice has now built the three hop payloads that will be wrapped in an onion. A simplified view of the payloads is shown in <a href="#onion_hop_payloads">Hop payloads for all the hops</a>. </p>
</div>
<div id="onion_hop_payloads" class="imageblock">
<div class="content">
<img src="images/mtln_1013.png" alt="Hop payloads for all the hops">
</div>
<div class="title">Figure 13. Hop payloads for all the hops</div>
</div>
</div>
</div>
<div class="sect3 pagebreak-before less_space">
<h4 id="_key_generation">Key Generation</h4>
<div class="paragraph">
<p>Alice must now generate several keys that will be used to encrypt the various layers in the onion.</p>
</div>
<div class="paragraph">
<p>With these keys, Alice can achieve a high degree of privacy and integrity:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Alice can encrypt each layer of the onion so that only the intended recipient can read it.</p>
</li>
<li>
<p>Every intermediary can check that the message is not modified.</p>
</li>
<li>
<p>No one in the path will know who sent this onion or where it is going. Alice doesn&#8217;t reveal her identity as the sender or Dina&#8217;s identity as the recipient of the payment.</p>
</li>
<li>
<p>Each hop only learns about the previous and next hop.</p>
</li>
<li>
<p>No one can know how long the path is, or where  in the path they are.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>Like a chopped onion, the following technical details may bring tears to your eyes. Feel free to skip to the next section if you get confused. Come back to this and read <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/04-onion-routing.md#packet-construction">BOLT #4: Onion Routing, Packet Construction</a>, if you want to learn more.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The basis for all the keys used in the onion is a <em>shared secret</em> that Alice and Bob can both generate independently using the Elliptic Curve DiffieHellman (ECDH) algorithm. From the shared secret (ss), they can independently generate four additional keys named rho, mu, um, and pad:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">rho</dt>
<dd>
<p>Used to generate a stream of random bytes from a stream cipher (used as a
CSPRNG). These bytes are used to encrypt/decrypt the message body as well as
filler zero bytes during Sphinx packet processing.</p>
</dd>
<dt class="hdlist1">mu</dt>
<dd>
<p>Used in the hash-based message authentication code (HMAC) for integrity/authenticity verification.</p>
</dd>
<dt class="hdlist1">um</dt>
<dd>
<p>Used in error reporting.</p>
</dd>
<dt class="hdlist1">pad</dt>
<dd>
<p>Used to generate filler bytes for padding the onion to a fixed length.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The relationship between the various keys and how they are generated is diagrammed in <a href="#onion_keygen">Onion key generation</a>.</p>
</div>
<div id="onion_keygen" class="imageblock">
<div class="content">
<img src="images/mtln_1014.png" alt="Onion Key Generation">
</div>
<div class="title">Figure 14. Onion key generation</div>
</div>
<div class="sect4">
<h5 id="session_key">Alice&#8217;s session key</h5>
<div class="paragraph">
<p>To avoid revealing her identity, Alice does not use her own node&#8217;s public key in building the onion. Instead, Alice creates a temporary 32-byte (256-bit) key called the <em>session private key</em> and corresponding <em>session public key</em>. This serves as a temporary "identity" and key <em>for this onion only</em>. From this session key, Alice will build all the other keys that will be used in this onion.</p>
</div>
</div>
<div class="sect4">
<h5 id="keygen_details">Key generation details</h5>
<div class="paragraph">
<p>The key generation, random byte generation, ephemeral keys, and how they are used in packet construction are specified in three sections of BOLT #4:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/04-onion-routing.md#key-generation">Key Generation</a></p>
</li>
<li>
<p><a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/04-onion-routing.md#pseudo-random-byte-stream">Random Byte Stream</a></p>
</li>
<li>
<p><a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/04-onion-routing.md#packet-construction">Packet Construction</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For simplicity and to avoid getting too technical, we have not included these details in the book. See the preceding links if you want to see the inner workings.</p>
</div>
</div>
<div class="sect4">
<h5 id="shared_secret">Shared secret generation</h5>
<div class="paragraph">
<p>One important detail that seems almost magical is the ability for Alice to create a <em>shared secret</em> with another node simply by knowing their public keys. This is based on the invention of DiffieHellman key exchange (DH) in the 1970s that revolutionized cryptography. Lightning onion routing uses Elliptic Curve DiffieHellman (ECDH) on Bitcoin&#8217;s secp256k1 curve. It&#8217;s such a cool trick that we try to explain it in simple terms in <a href="#ecdh_explained">Elliptic Curve DiffieHellman Explained</a>.</p>
</div>
<div id="ecdh_explained" class="sidebarblock">
<div class="content">
<div class="title">Elliptic Curve DiffieHellman Explained</div>
<div class="paragraph">
<p>Assume Alice&#8217;s private key is <em>a</em> and Bob&#8217;s private key is <em>b</em>. Using the elliptic curve, Alice and Bob each multiply their private key by the generator point <em>G</em> to produce their public keys <em>A</em> and <em>B</em>, respectively:</p>
</div>
<ul class="simplelist">
<li><em>A</em> = <em>aG</em></li>
<li><em>B</em> = <em>bG</em></li>
</ul>
<div class="paragraph">
<p>Now Alice and Bob can use <em>Elliptic Curve DiffieHellman Key Exchange</em> to create a shared secret <em>ss</em>, a value that they can both calculate independently without exchanging any information</p>
</div>
<div class="paragraph">
<p>The shared secret <em>ss</em> is calculated by each by multiplying their own private key with the <em>other&#8217;s</em> public key, such that:</p>
</div>
<ul class="simplelist">
<li><em>ss</em> = <em>aB</em> = <em>bA</em></li>
</ul>
<div class="paragraph">
<p>But why would these two multiplications result in the same value <em>ss</em>?
Follow along, as we demonstrate the math that proves this is possible:</p>
</div>
<ul class="simplelist">
<li><em>ss</em></li>
<li>= <em>aB</em></li>
</ul>
<div class="paragraph">
<p>calculated by Alice who knows both <em>a</em> (her private key) and <em>B</em> (Bob&#8217;s public key)</p>
</div>
<ul class="simplelist">
<li>= <em>a</em>(<em>bG</em>)</li>
</ul>
<div class="paragraph">
<p>because we know that <em>B</em> = <em>bG</em>, we substitute</p>
</div>
<ul class="simplelist">
<li> = (<em>ab</em>)<em>G</em></li>
</ul>
<div class="paragraph">
<p>because of associativity, we can move the parentheses</p>
</div>
<ul class="simplelist">
<li>= (<em>ba</em>)<em>G</em></li>
</ul>
<div class="paragraph">
<p>because <em>xy</em> = <em>yx</em> (the curve is an abelian group)</p>
</div>
<ul class="simplelist">
<li>= <em>b</em>(<em>aG</em>)</li>
</ul>
<div class="paragraph">
<p>because of associativity, we can move the parentheses</p>
</div>
<ul class="simplelist">
<li>= <em>bA</em></li>
</ul>
<div class="paragraph">
<p>and we can substitute <em>aG</em> with <em>A</em>.</p>
</div>
<div class="paragraph">
<p>The result <em>bA</em> can be calculated independently by Bob who knows <em>b</em> (his private key) and <em>A</em> (Alice&#8217;s public key).</p>
</div>
<div class="paragraph">
<p>We have therefore shown that:</p>
</div>
<ul class="simplelist">
<li><em>ss</em> = <em>aB</em> (Alice can calculate this)</li>
<li><em>ss</em> = <em>bA</em> (Bob can calculate this)</li>
</ul>
<div class="paragraph">
<p>Thus, they can each independently calculate <em>ss</em> which they can use as a shared key to symmetrically encrypt secrets between the two of them without communicating the shared secret.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>A unique trait of Sphinx as a mix-net packet format is that rather than include a distinct session key for each hop in the route, which would increase the size of the mix-net packet dramatically, a clever <em>blinding</em> scheme is used to deterministically randomize the session key at each hop.</p>
</div>
<div class="paragraph">
<p>In practice, this little trick allows us to keep the onion packet as compact as possible while still retaining the desired security properties.</p>
</div>
<div class="paragraph">
<p>The session key for hop <code>i</code> is derived using the node public key, and derived shared secret of hop <code>i  1</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>session_key_i = session_key_{i-1} * SHA-256(node_pubkey_{i-1} || shared_secret_{i-1})</code></pre>
</div>
</div>
<div class="paragraph">
<p>In other words, we take the session key of the prior hop, and multiply it by a value derived from the public key and the derived shared secret for that hop.</p>
</div>
<div class="paragraph">
<p>As elliptic curve multiplication can be performed on a public key without knowledge of the private key, each hop is able to re-randomize the session key for the next hop in a deterministic fashion.</p>
</div>
<div class="paragraph">
<p>The creator of the onion packet knows all the shared secrets (as they&#8217;ve encrypted the packet uniquely for each hop), and thus are able to derive all the blinding factors.</p>
</div>
<div class="paragraph">
<p>This knowledge allows them to derive all the session keys used up front during packet generation.</p>
</div>
<div class="paragraph">
<p>Note that the very first hop uses the original session key generated because this key is used to kick off the session key blinding by each subsequent hop.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="wrapping_the_onion">Wrapping the Onion Layers</h3>
<div class="paragraph">
<p>The process of wrapping the onion is detailed in <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/04-onion-routing.md#packet-construction">BOLT #4: Onion Routing, Packet Construction</a>.</p>
</div>
<div class="paragraph">
<p>In this section we will describe this process at a high and somewhat simplified level, omitting certain details.</p>
</div>
<div class="sect3">
<h4 id="fixed_length_onions">Fixed-Length Onions</h4>
<div class="paragraph">
<p>We&#8217;ve mentioned the fact that none of the "hop" nodes know how long the path is, or where they are in the path. How is this possible?</p>
</div>
<div class="paragraph">
<p>If you have a set of directions, even if encrypted, can&#8217;t you tell how far you are from the beginning or end simply by looking at <em>where</em> in the list of directions you are?</p>
</div>
<div class="paragraph">
<p>The trick used in onion routing is to always make the path (the list of directions) the same length for every node. This is achieved by keeping the onion packet the same length at every step.</p>
</div>
<div class="paragraph">
<p>At each hop, the hop payload appears at the beginning of the onion payload, followed by <em>what seem to be</em> 19 more hop payloads. Every hop sees itself as the first of 20 hops.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>The onion payload is 1,300 bytes. Each hop payload is 65 bytes or less (padded to 65 bytes if less). So the total onion payload can fit 20 hop payloads (1300 = 20 &times; 65). The maximum onion routed path is therefore 20 hops.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As each layer is "peeled off," more filler data (essentially junk) is added at the end of the onion payload so the next hop gets an onion of the same size and is once again the "first hop" in the onion.</p>
</div>
<div class="paragraph">
<p>The onion size is 1,366 bytes, structured as shown in <a href="#onion_packet">The onion packet</a>:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">1 byte</dt>
<dd>
<p>A version byte</p>
</dd>
<dt class="hdlist1">33 bytes</dt>
<dd>
<p>A compressed public session key (<a href="#session_key">Alice&#8217;s session key</a>) from which the per-hop shared secret (<a href="#shared_secret">Shared secret generation</a>) can be generated without revealing Alice&#8217;s identity</p>
</dd>
<dt class="hdlist1">1,300 bytes</dt>
<dd>
<p>The actual <em>onion payload</em> containing the instructions for each hop</p>
</dd>
<dt class="hdlist1">32 bytes</dt>
<dd>
<p>An HMAC integrity checksum</p>
</dd>
</dl>
</div>
<div id="onion_packet" class="imageblock">
<div class="content">
<img src="images/mtln_1015.png" alt="mtln 1015">
</div>
<div class="title">Figure 15. The onion packet</div>
</div>
<div class="paragraph">
<p>A unique trait of Sphinx as a mix-net packet format is that rather than include a distinct session key for each hop in the route, which would increase the size of the mix-net packet dramatically, instead a clever <em>blinding</em> scheme is used to deterministically randomize the session key at each hop.</p>
</div>
<div class="paragraph">
<p>In practice, this little trick allows us to keep the onion packet as compact as possible while still retaining the desired security properties.</p>
</div>
</div>
<div class="sect3">
<h4 id="_wrapping_the_onion_outlined">Wrapping the Onion (Outlined)</h4>
<div class="paragraph">
<p>Here is the process of wrapping the onion, outlined next. Come back to this list as we explore each step with our real-world example.</p>
</div>
<div class="paragraph">
<p>For each hop, the sender (Alice) repeats the same process:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Alice generates the per-hop shared secret and the rho, mu, and pad keys.</p>
</li>
<li>
<p>Alice generates 1,300 bytes of filler and fills the 1,300-byte onion payload field with this filler.</p>
</li>
<li>
<p>Alice calculates the HMAC for the hop payload (zeros for the final hop).</p>
</li>
<li>
<p>Alice calculates the length of the hop payload + HMAC + space to store the length itself.</p>
</li>
<li>
<p>Alice <em>right-shifts</em> the onion payload by the calculated space needed to fit the hop payload. The rightmost "filler" data is discarded, making enough space on the left for the payload.</p>
</li>
<li>
<p>Alice inserts the length + hop payload + HMAC at the front of the payload field in the space made from shifting the filler.</p>
</li>
<li>
<p>Alice uses the rho key to generate a 1,300-byte one-time pad.</p>
</li>
<li>
<p>Alice obfuscates the entire onion payload by XORing with the bytes generated from rho.</p>
</li>
<li>
<p>Alice calculates the HMAC of the onion payload, using the mu key.</p>
</li>
<li>
<p>Alice adds the session public key (so that the hop can calculate the shared secret).</p>
</li>
<li>
<p>Alice adds the version number.</p>
</li>
<li>
<p>Alice deterministically re-blinds the session key using a value derived by hashing the shared secret and prior hop&#8217;s public key.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Next, Alice repeats the process. The new keys are calculated, the onion payload is shifted (dropping more junk), the new hop payload is added to the front, and the whole onion payload is encrypted with the rho byte stream for the next hop.</p>
</div>
<div class="paragraph">
<p>For the final hop, the HMAC included in Step #3 over the plain-text instructions is actually <em>all zero</em>.
The final hop uses this signal to determine that it is indeed the final hop in the route.
Alternatively, the fact that the <code>short_chan_id</code> included in the payload to denote the "next hop" is all zero can be used as well.</p>
</div>
<div class="paragraph">
<p>Note that at each phase the mu key is used to generate an HMAC over the <em>encrypted</em> (from the point of view of the node processing the payload) onion packet, as well as over the contents of the packet with a single layer of encryption removed.
This outer HMAC allows the node processing the packet to verify the integrity of the onion packet (no bytes modified).
The inner HMAC is then revealed during the inverse of the "shift and encrypt" routine described previously, which serves as the <em>outer</em> HMAC for the next hop.</p>
</div>
</div>
<div class="sect3">
<h4 id="_wrapping_dinas_hop_payload">Wrapping Dina&#8217;s Hop Payload</h4>
<div class="paragraph">
<p>As a reminder, the onion is wrapped by starting at the end of the path from Dina, the final node or recipient. Then the path is built in reverse all the way back to the sender, Alice.</p>
</div>
<div class="paragraph">
<p>Alice starts with an empty 1,300-byte field, the fixed-length <em>onion payload</em>. Then, she fills the onion payload with a pseudorandom byte stream "filler" that is generated from the pad key.</p>
</div>
<div class="paragraph">
<p>This is shown in <a href="#onion_payload_filler">Filling the onion payload with a random byte stream</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Random byte stream generation uses the ChaCha20 algorithm, as a cryptographic secure pseudorandom number generator (CSPRNG). Such an algorithm will generate a deterministic, long, nonrepeating stream of seemingly random bytes from an initial seed. The details are specified in <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/04-onion-routing.md#pseudo-random-byte-stream">BOLT #4: Onion Routing, Pseudo Random Byte Stream</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="onion_payload_filler" class="imageblock">
<div class="content">
<img src="images/mtln_1016.png" alt="mtln 1016">
</div>
<div class="title">Figure 16. Filling the onion payload with a random byte stream</div>
</div>
<div class="paragraph">
<p>Alice will now insert Dina&#8217;s hop payload into the left side of the 1,300-byte array, shifting the filler to the right and discarding anything that overflows. This is visualized in <a href="#onion_add_dina">Adding Dina&#8217;s hop payload</a>.</p>
</div>
<div id="onion_add_dina" class="imageblock">
<div class="content">
<img src="images/mtln_1017.png" alt="mtln 1017">
</div>
<div class="title">Figure 17. Adding Dina&#8217;s hop payload</div>
</div>
<div class="paragraph">
<p>Another way to look at this is that Alice measures the length of Dina&#8217;s hop payload, shifts the filler right to create an equal space in the left side of the onion payload, and inserts Dina&#8217;s payload in that space.</p>
</div>
<div class="paragraph">
<p>Next row down we see the result: the 1,300 byte onion payload contains Dina&#8217;s hop payload and then the filler byte stream filling up the rest of the space.</p>
</div>
<div class="paragraph">
<p>Next, Alice obfuscates the entire onion payload so that <em>only Dina</em> can read it.</p>
</div>
<div class="paragraph">
<p>To do this, Alice generates a byte stream using the rho key (which Dina also knows). Alice uses a bitwise exclusive or (XOR) between the bits of the onion payload and the byte stream created from rho. The result appears like a random (or encrypted) byte stream of 1,300 bytes length. This step is shown in <a href="#onion_obfuscate_dina">Obfuscating the onion payload</a>.</p>
</div>
<div id="onion_obfuscate_dina" class="imageblock">
<div class="content">
<img src="images/mtln_1018.png" alt="mtln 1018">
</div>
<div class="title">Figure 18. Obfuscating the onion payload</div>
</div>
<div class="paragraph">
<p>One of the properties of XOR is that if you do it twice, you get back to the original data. As we will see in <a href="#bobDeobfuscates">Bob De-Obfuscates His Hop Payload</a>, if Dina applies the same XOR operation with the byte stream generated from rho, it will reveal the original onion payload.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>XOR is an <em>involutory</em> function, which means that if it is applied twice, it undoes itself. Specifically XOR(XOR(<em>a</em>, <em>b</em>), <em>b</em>) = <em>a</em>. This property is used extensively in symmetric-key cryptography.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Because only Alice and Dina have the rho key (derived from Alice and Dina&#8217;s shared secret), only they can do this. Effectively, this encrypts the onion payload for Dina&#8217;s eyes only.</p>
</div>
<div class="paragraph">
<p>Finally, Alice calculates a hash-based message authentication code (HMAC) for Dina&#8217;s payload, which uses the mu key as its initialization key. This is shown in <a href="#dina_hop_payload_hmac">Adding an HMAC integrity checksum to Dina&#8217;s hop payload</a>.</p>
</div>
<div id="dina_hop_payload_hmac" class="imageblock">
<div class="content">
<img src="images/mtln_1019.png" alt="mtln 1019">
</div>
<div class="title">Figure 19. Adding an HMAC integrity checksum to Dina&#8217;s hop payload</div>
</div>
<div class="sect4">
<h5 id="_onion_routing_replay_protection_and_detection">Onion routing replay protection and detection</h5>
<div class="paragraph">
<p>The HMAC acts as a secure checksum and helps Dina verify the integrity of the hop payload. The 32-byte HMAC is appended to Dina&#8217;s hop payload.
Note that we compute the HMAC over the <em>encrypted</em> data rather then over the plain-text data.
This is known as <em>encrypt-then-mac</em> and is the recommended way to use a MAC, as it provides both plain-text <em>and</em> ciphertext integrity.</p>
</div>
<div class="paragraph">
<p>Modern authenticated encryption also allows for the use of an optional set of plaintext bytes to also be authenticated, known as <em>associated data.</em>
In practice, this is usually something like a plain-text packet header or other auxiliary information.
By including this associated data in the payload to be authenticated (MAC&#8217;ed), the verifier of the MAC ensures that this associated data hasn&#8217;t been tampered with (e.g., swapping out the plain-text header on an encrypted packet).</p>
</div>
<div class="paragraph">
<p>In the context of the Lightning Network, this associated data is used to <em>strengthen</em> the replay protection of this scheme.
As we&#8217;ll learn in the following, replay protection ensures that an attacker can&#8217;t <em>retransmit</em> (replay) a packet into the network and observe its resulting path.
Instead, intermediate nodes are able to use the defined replay protection measures to detect and reject a replayed packet.
The base Sphinx packet format uses a log of all the ephemeral secret keys used to detect replays.
If a secret key is ever used again, then the node can detect it and reject the packet.</p>
</div>
<div class="paragraph">
<p>The nature of HTLCs in the Lightning Network allows us to further strengthen the replay protection by adding an additional <em>economic</em> incentive.
Remember that the payment hash of an HTLC can only ever safely be used (for a complete payment) once.
If a payment hash is used again and traverses a node that has already seen the payment secret for that hash, then they can simply pull the funds and collect the entire payment amount without forwarding!
We can use this fact to strengthen the replay protection by requiring that the <em>payment hash</em> is included in our HMAC computation as the associated data.
With this added step, attempting to replay an onion packet also requires the sender to commit to using the <em>same</em> payment hash.
As a result, on top of the normal replay protection, an attacker also stands to lose the entire amount of the HTLC replayed.</p>
</div>
<div class="paragraph">
<p>One consideration with the ever-increasing set of session keys stored for replay protection is: are nodes able to reclaim this space?
In the context of the Lightning Network, the answer is: yes!
Once again, due to the unique attributes of the HTLC construct, we can make a further improvement over the base Sphinx protocol.
Given that HTLCs are <em>time-locked</em> contracts based on the absolute block height, once an HTLC has expired, then the contract is effectively permanently closed.
As a result, nodes can use this CLTV (CHECKLOCKTIMEVERIFY operator) expiration height as an indicator to know when it&#8217;s safe to garbage collect an entry in the anti-replay log.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_wrapping_chans_hop_payload">Wrapping Chan&#8217;s Hop Payload</h4>
<div class="paragraph">
<p>In <a href="#chan_onion_wrapping">Wrapping the onion for Chan</a> we see the steps used to wrap Chan&#8217;s hop payload in the onion. These are the same steps Alice used to wrap Dina&#8217;s hop payload.</p>
</div>
<div id="chan_onion_wrapping" class="imageblock">
<div class="content">
<img src="images/mtln_1020.png" alt="mtln 1020">
</div>
<div class="title">Figure 20. Wrapping the onion for Chan</div>
</div>
<div class="paragraph">
<p>Alice starts with the 1,300 onion payload created for Dina. The first 65 (or fewer) bytes of this are Dina&#8217;s payload obfuscated and the rest is filler. Alice must be careful not to overwrite Dina&#8217;s payload.</p>
</div>
<div class="paragraph">
<p>Next, Alice needs to locate the ephemeral public key (which was generated at the very start for each hop) that will be prepended to the routing packet at this hop.</p>
</div>
<div class="paragraph">
<p>Remember that rather than include a unique ephemeral public key (that the sender and intermediate node use in an ECDH operation to generate a shared secret), Sphinx uses a single ephemeral public key that is deterministically randomized at each hop.</p>
</div>
<div class="paragraph">
<p>When processing the packet, Dina will use her shared secret and public key to derive the blinding value (<code>b_dina</code>) and use that to re-randomize the ephemeral public key, in an identical operation to what Alice performs during initial packet construction.</p>
</div>
<div class="paragraph">
<p>Alice adds an inner HMAC checksum to Chan&#8217;s payload and inserts it at the "front" (left side) of the onion payload, shifting the existing payload to the right by an equal amount.
Remember that there are effectively <em>two</em> HMACs used in the scheme: the outer HMAC and the inner HMAC.
In this case, Chan&#8217;s <em>inner</em> HMAC is actually Dina&#8217;s <em>outer</em> HMAC.</p>
</div>
<div class="paragraph">
<p>Now Chan&#8217;s payload is in the front of the onion. When Chan sees this, he has no idea how many payloads came before or after. It looks like the first of 20 hops always!</p>
</div>
<div class="paragraph">
<p>Next, Alice obfuscates the entire payload by XOR with the byte stream generated from the Alice-Chan rho key. Only Alice and Chan have this rho key, and only they can produce the byte stream to obfuscate and de-obfuscate the onion.
Finally, as we did in the earlier step, we compute Chan&#8217;s outer HMAC, which is what she&#8217;ll use to verify the integrity of the encrypted onion packet.</p>
</div>
</div>
<div class="sect3">
<h4 id="_wrapping_bobs_hop_payload">Wrapping Bob&#8217;s Hop Payload</h4>
<div class="paragraph">
<p>In <a href="#bob_onion_wrapping">Wrapping the onion for Bob</a> we see the steps used to wrap Bob&#8217;s hop payload in the onion.</p>
</div>
<div class="paragraph">
<p>All right, by now this is easy!</p>
</div>
<div class="paragraph">
<p>Start with the onion payload (obfuscated) containing Chan&#8217;s and Dina&#8217;s hop payloads.</p>
</div>
<div class="paragraph">
<p>Obtain the session key for this hop dervied from the blinding factor generated by the prior hop.
Include the prior hop&#8217;s outer HMAC as this hop&#8217;s inner HMAC.
Insert Bob&#8217;s hop payload at the beginning and shift everything else over to the right, dropping a Bob-hop-payload-size chunk from the end (it was filler anyway).</p>
</div>
<div class="paragraph">
<p>Obfuscate the whole thing XOR with the rho key from the Alice-Bob shared secret so that only Bob can unwrap this.</p>
</div>
<div class="paragraph">
<p>Calculate the outer HMAC and stick it on the end of Bob&#8217;s hop payload.</p>
</div>
<div id="bob_onion_wrapping" class="imageblock">
<div class="content">
<img src="images/mtln_1021.png" alt="mtln 1021">
</div>
<div class="title">Figure 21. Wrapping the onion for Bob</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_final_onion_packet">The Final Onion Packet</h4>
<div class="paragraph">
<p>The final onion payload is ready to be sent to Bob. Alice doesn&#8217;t need to add any more hop payloads.</p>
</div>
<div class="paragraph">
<p>Alice calculates an HMAC for the onion payload to cryptographically secure it with a checksum that Bob can verify.</p>
</div>
<div class="paragraph">
<p>Alice adds a 33-byte public session key that will be used by each hop to generate a shared secret and the rho, mu, and pad keys.</p>
</div>
<div class="paragraph">
<p>Finally Alice puts the onion version number (0 currently) in the front. This allows for future upgrades of the onion packet format.</p>
</div>
<div class="paragraph">
<p>The result can be seen in <a href="#onion_packet_2">The onion packet</a>. </p>
</div>
<div id="onion_packet_2" class="imageblock">
<div class="content">
<img src="images/mtln_1015.png" alt="mtln 1015">
</div>
<div class="title">Figure 22. The onion packet</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sending_the_onion">Sending the Onion</h3>
<div class="paragraph">
<p>In this section we will look at how the onion packet is forwarded and how HTLCs are deployed along the path.</p>
</div>
<div class="sect3">
<h4 id="_the_update_add_htlc_message">The update_add_htlc Message</h4>
<div class="paragraph">
<p>Onion packets are sent as part of the update_add_htlc message. If you recall from <a href="#update_add_htlc">[update_add_htlc]</a>, in <a href="#channel_operation">[channel_operation]</a>, we saw the contents of the update_add_htlc message are as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[channel_id:channel_id]
[u64:id]
[u64:amount_msat]
[sha256:payment_hash]
[u32:cltv_expiry]
[1366*byte:onion_routing_packet]</pre>
</div>
</div>
<div class="paragraph">
<p>You will recall that this message is sent by one channel partner to ask the other channel partner to add an HTLC. This is how Alice will ask Bob to add an HTLC to pay Dina. Now you understand the purpose of the last field, onion_routing_packet, which is 1,366 bytes long. It&#8217;s the fully wrapped onion packet we just constructed!</p>
</div>
</div>
<div class="sect3">
<h4 id="_alice_sends_the_onion_to_bob">Alice Sends the Onion to Bob</h4>
<div class="paragraph">
<p>Alice will send the update_add_htlc message to Bob. Let&#8217;s look at what this message will contain:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">channel_id</dt>
<dd>
<p>This field contains the Alice-Bob channel ID, which in our example is 0000031e192ca1 (see <a href="#alice_dina_path_detail">A detailed path constructed from gossiped channel and node information</a>).</p>
</dd>
<dt class="hdlist1">id</dt>
<dd>
<p>The ID of this HTLC in this channel, starting at 0.</p>
</dd>
<dt class="hdlist1">amount_msat</dt>
<dd>
<p>The amount of the HTLC: 50,200,000 millisatoshis.</p>
</dd>
<dt class="hdlist1">payment_hash</dt>
<dd>
<p>The RIPEMD160(SHA-256) payment hash:</p>
<div class="paragraph">
<p>9e017f6767971ed7cea17f98528d5f5c0ccb2c71.</p>
</div>
</dd>
<dt class="hdlist1">cltv_expiry</dt>
<dd>
<p>The expiry timelock for the HTLC will be 700,058. Alice adds 20 blocks to the expiry set in Bob&#8217;s payload according to Bob&#8217;s negotiated cltv_expiry_delta.</p>
</dd>
<dt class="hdlist1">onion_routing_packet</dt>
<dd>
<p>The final onion packet Alice constructed with all the hop payloads!</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_bob_checks_the_onion">Bob Checks the Onion</h4>
<div class="paragraph">
<p>As we saw in <a href="#channel_operation">[channel_operation]</a>, Bob will add the HTLC to the commitment transactions and update the state of the channel with Alice.</p>
</div>
<div class="paragraph">
<p>Bob will unwrap the onion he received from Alice as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Bob takes the session key from the onion packet and derives the Alice-Bob shared secret.</p>
</li>
<li>
<p>Bob generates the mu key from the shared secret and uses it to verify the onion packet HMAC checksum.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now that Bob has generated the shared key and verified the HMAC, he can start unwrapping the 1,300 byte onion payload inside the onion packet. The goal is for Bob to retrieve his own hop payload and then forward the remaining onion to the next hop.</p>
</div>
<div class="paragraph">
<p>If Bob extracts and removes his hop payload, the remaining onion will not be 1,300 bytes, it will be shorter! So the next hop will know that they are not the first hop and will be able to detect how long the path is. To prevent this, Bob needs to add more filler to refill the onion.</p>
</div>
</div>
<div class="sect3">
<h4 id="_bob_generates_filler">Bob Generates Filler</h4>
<div class="paragraph">
<p>Bob generates filler in a slightly different way than Alice, but following the same general principle.</p>
</div>
<div class="paragraph">
<p>First, Bob <em>extends</em> the onion payload by 1,300 bytes and fills them with 0 values. Now the onion packet is 2,600 bytes long, with the first half containing the data Alice sent and the next half containing zeroes. This operation is shown in <a href="#bob_extends">Bob extends the onion payload by 1,300 (zero-filled) bytes</a>.</p>
</div>
<div id="bob_extends" class="imageblock">
<div class="content">
<img src="images/mtln_1023.png" alt="Bob extends the onion payload by 1,300 (zero-filled) bytes">
</div>
<div class="title">Figure 23. Bob extends the onion payload by 1,300 (zero-filled) bytes</div>
</div>
<div class="paragraph">
<p>This empty space will become obfuscated and turn into "filler" by the same process that Bob uses to de-obfuscate his own hop payload. Let&#8217;s see how that works.</p>
</div>
</div>
<div class="sect3">
<h4 id="bobDeobfuscates">Bob De-Obfuscates His Hop Payload</h4>
<div class="paragraph">
<p>Next, Bob will generate the rho key from the Alice-Bob shared key. He will use this to generate a 2,600 byte stream, using the ChaCha20 algorithm.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>The first 1,300 bytes of the byte stream generated by Bob are exactly the same as those generated by Alice using the rho key.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, Bob applies the 2,600 bytes of the rho byte stream to the 2,600-byte onion payload with a bitwise XOR operation.</p>
</div>
<div class="paragraph">
<p>The first 1,300 bytes will become de-obfuscated by this XOR operation, because it is the same operation Alice applied and XOR is involutory. So Bob will <em>reveal</em> his hop payload followed by some data that seems scrambled.</p>
</div>
<div class="paragraph">
<p>At the same time, applying the rho byte stream to the 1,300 zeroes that were added to the onion payload will turn them into seemingly random filler data. This operation is shown in <a href="#bob_deobfuscates">Bob de-obfuscates the onion, obfuscates the filler</a>.</p>
</div>
<div id="bob_deobfuscates" class="imageblock">
<div class="content">
<img src="images/mtln_1024.png" alt="Bob de-obfuscates the onion, obfuscates the filler">
</div>
<div class="title">Figure 24. Bob de-obfuscates the onion, obfuscates the filler</div>
</div>
</div>
<div class="sect3">
<h4 id="_bob_extracts_the_outer_hmac_for_the_next_hop">Bob Extracts the Outer HMAC for the Next Hop</h4>
<div class="paragraph">
<p>Remember that an inner HMAC is included for each hop, which will then become the outer HMAC for the <em>next</em> hop.
In this case, Bob extracts the inner HMAC (he&#8217;s already verified the integrity of the encrypted packet with the outer HMAC), and puts it aside because he&#8217;ll append it to the de-obfuscated packet to allow Chan to verify the HMAC of his encrypted packet.</p>
</div>
</div>
<div class="sect3">
<h4 id="_bob_removes_his_payload_and_left_shifts_the_onion">Bob Removes His Payload and Left-Shifts the Onion</h4>
<div class="paragraph">
<p>Now Bob can remove his hop payload from the front of the onion and left-shift the remaining data. An amount of data equal to Bob&#8217;s hop payload from the second-half 1,300 bytes of filler will now shift into the onion payload space. This is shown in <a href="#bob_removes_shifts">Bob removes the hop payload and left-shifts the rest, filling the gap with new filler</a>.</p>
</div>
<div class="paragraph">
<p>Now Bob can keep the first half 1,300 bytes, and discard the extended (filler) 1,300 bytes.</p>
</div>
<div class="paragraph">
<p>Bob now has a 1,300-byte onion packet to send to the next hop. It is almost identical to the onion payload that Alice had created for Chan, except that the last 65 or so bytes of filler was put there by Bob and will be different.</p>
</div>
<div id="bob_removes_shifts" class="imageblock">
<div class="content">
<img src="images/mtln_1025.png" alt="Bob removes the hop payload and left-shifts the rest, filling the gap with new filler">
</div>
<div class="title">Figure 25. Bob removes the hop payload and left-shifts the rest, filling the gap with new filler</div>
</div>
<div class="paragraph pagebreak-before">
<p>No one can tell the difference between filler put there by Alice and filler put there by Bob. Filler is filler! It&#8217;s all random bytes anyway. Note that if Bob (or one of Bob&#8217;s other aliases) is present in the route in two distinct locations, then they can tell the difference because the base protocol always uses the same payment hash across the entire route. Atomic multipath payments (AMPs) and Point Time-Locked Contracts (PTLCs) eliminate the correlation vector by randomizing the payment identifier across each route/hop.</p>
</div>
</div>
<div class="sect3">
<h4 id="_bob_constructs_the_new_onion_packet">Bob Constructs the New Onion Packet</h4>
<div class="paragraph">
<p>Bob now copies the onion payload into the onion packet, appends the outer HMAC for chan, re-randomizes the session key (the same way Alice the sender does) with the elliptic curve multiplication operation, and appends a fresh version byte.</p>
</div>
<div class="paragraph">
<p>To re-randomize the session key, Bob first computes the blinding factor for his hop, using his node public key and the shared secret he derived:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>b_bob = SHA-256(P_bob || shared_secret_bob)</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this generated, Bob now re-randomizes the session key by performing an EC multiplication using his session key and the blinding factor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>session_key_chan = session_key_bob * b_bob</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>session_key_chan</code> public key will then be appended to the front of the onion packet for processing by Chan.</p>
</div>
</div>
<div class="sect3">
<h4 id="_bob_verifies_the_htlc_details">Bob Verifies the HTLC Details</h4>
<div class="paragraph">
<p>Bob&#8217;s hop payload contains the instructions needed to create an HTLC for Chan.</p>
</div>
<div class="paragraph">
<p>In the hop payload, Bob finds a short_channel_id, amt_to_forward, and cltv_expiry.</p>
</div>
<div class="paragraph">
<p>First, Bob checks to see if he has a channel with that short ID. He finds that he has such a channel with Chan.</p>
</div>
<div class="paragraph">
<p>Next, Bob confirms that the outgoing amount (50,100 satoshis) is less than the incoming amount (50,200 satoshis), and therefore Bob&#8217;s fee expectations are met.</p>
</div>
<div class="paragraph">
<p>Similarly, Bob checks that the outgoing cltv_expiry is less than the incoming cltv_expiry, giving Bob enough time to claim the incoming HTLC if there is a breach.</p>
</div>
</div>
<div class="sect3">
<h4 id="_bob_sends_the_update_add_htlc_to_chan">Bob Sends the update_add_htlc to Chan</h4>
<div class="paragraph">
<p>Bob now constructs and HTLC to send to Chan, as follows:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">channel_id</dt>
<dd>
<p>This field contains the Bob-Chan channel ID, which in our example is 000004040a61f0 (see <a href="#alice_dina_path_detail">A detailed path constructed from gossiped channel and node information</a>).</p>
</dd>
<dt class="hdlist1">id</dt>
<dd>
<p>The ID of this HTLC in this channel, starting at 0.</p>
</dd>
<dt class="hdlist1">amount_msat</dt>
<dd>
<p>The amount of the HTLC: 50,100,000 millisatoshis.</p>
</dd>
<dt class="hdlist1">payment_hash</dt>
<dd>
<p>The RIPEMD160(SHA-256) payment hash:</p>
<div class="paragraph">
<p>9e017f6767971ed7cea17f98528d5f5c0&amp;#x200b;ccb2c71.</p>
</div>
<div class="paragraph">
<p>This is the same as the payment hash from Alice&#8217;s HTLC.</p>
</div>
</dd>
<dt class="hdlist1">cltv_expiry</dt>
<dd>
<p>The expiry timelock for the HTLC will be 700,038.</p>
</dd>
<dt class="hdlist1">onion_routing_packet</dt>
<dd>
<p>The onion packet Bob reconstructed after removing his hop payload.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_chan_forwards_the_onion">Chan Forwards the Onion</h4>
<div class="paragraph">
<p>Chan repeats the exact same process as Bob:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Chan receives the update_add_htlc and processes the HTLC request, adding it to commitment transactions.</p>
</li>
<li>
<p>Chan generates the Alice-Chan shared key and the mu subkey.</p>
</li>
<li>
<p>Chan verifies the onion packet HMAC, then extracts the 1,300-byte onion <span class="keep-together">payload</span>.</p>
</li>
<li>
<p>Chan extends the onion payload by 1,300 extra bytes, filling it with zeroes.</p>
</li>
<li>
<p>Chan uses the rho key to produce 2,600 bytes.</p>
</li>
<li>
<p>Chan uses the generated byte stream to XOR and de-obfuscate the onion payload. Simultaneously, the XOR operation obfuscates the extra 1,300 zeroes, turning them into filler.</p>
</li>
<li>
<p>Chan extracts the inner HMAC in the payload, which will become the outer HMAC for Dina.</p>
</li>
<li>
<p>Chan removes his hop payload and left-shifts the onion payload by the same amount. Some of the filler generated in the 1,300 extended bytes moves into the first-half 1,300 bytes, becoming part of the onion payload.</p>
</li>
<li>
<p>Chan constructs the onion packet for Dina with this onion payload.</p>
</li>
<li>
<p>Chan builds an update_add_htlc message for Dina and inserts the onion packet into it.</p>
</li>
<li>
<p>Chan sends the update_add_htlc to Dina.</p>
</li>
<li>
<p>Chan re-randomizes the session key as Bob did in the prior hop for Dina.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_dina_receives_the_final_payload">Dina Receives the Final Payload</h4>
<div class="paragraph">
<p>When Dina receives the update_add_htlc message from Chan, she knows from the payment_hash that this is a payment for her. She knows she is the last hop in the onion.</p>
</div>
<div class="paragraph">
<p>Dina follows the exact same process as Bob and Chan to verify and unwrap the onion, except she doesn&#8217;t construct new filler and doesn&#8217;t forward anything. Instead, Dina responds to Chan with update_fulfill_htlc to redeem the HTLC. The update_fulfill_htlc will flow backward along the path until it reaches Alice. All the HTLCs are redeemed and channel balances are updated. The payment is complete!</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_returning_errors">Returning Errors</h3>
<div class="paragraph">
<p>This far we&#8217;ve looked at the forward propagation of the onion establishing the HTLCs and the backward propagation of the payment secret unwinding the HTLCs once payment is successful.</p>
</div>
<div class="paragraph">
<p>There is another very important function of onion routing: <em>error return</em>. If there is a problem with the payment, onion, or hops, we must propagate an error backwards to inform all nodes of the failure and unwind any HTLCs.</p>
</div>
<div class="paragraph">
<p>Errors generally fall into three categories: onion failures, node failures, and channel failures. These furthermore may be subdivided into permanent and transient errors. Finally, some errors contain channel updates to help with future payment delivery attempts.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Unlike messages in the peer-to-peer (P2P) protocol (defined in <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/02-peer-protocol.md">BOLT #2: Peer Protocol for Channel Management</a>), errors are not sent as P2P messages but are wrapped inside onion return packets and follow the reverse of the onion path (back-propagating).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Error return is defined in <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/04-onion-routing.md#returning-errors">BOLT #4: Onion Routing, Returning Errors</a>.</p>
</div>
<div class="paragraph">
<p>Errors are encoded by the returning node (the one that discovered an error) in a <em>return packet</em> as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    [32*byte:hmac]
    [u16:failure_len]
    [failure_len*byte:failuremsg]
    [u16:pad_len]
    [pad_len*byte:pad]</pre>
</div>
</div>
<div class="paragraph">
<p>The return packet HMAC verification checksum is calculated with the um key, generated from the shared secret established by the onion.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>The um key name is the reverse of the mu name, indicating the same use but in the opposite direction (back-propagation).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, the returning node generates an ammag (inverse of the word "gamma") key and obfuscates the return packet using an XOR operation with a byte stream generated from ammag.</p>
</div>
<div class="paragraph">
<p>Finally the return node sends the return packet to the hop from which it received the original onion.</p>
</div>
<div class="paragraph">
<p>Each hop receiving an error will generate an ammag key and obfuscate the return packet again using an XOR operation with the byte stream from ammag.</p>
</div>
<div class="paragraph">
<p>Eventually, the sender (origin node) receives a return packet. It will then generate ammag and um keys for each hop and XOR de-obfuscate the return error iteratively until it reveals the return packet.</p>
</div>
<div class="sect3">
<h4 id="failure_messages">Failure Messages</h4>
<div class="paragraph">
<p>The failuremsg is defined in <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/04-onion-routing.md#failure-messages">BOLT #4: Onion Routing, Failure Messages</a>.</p>
</div>
<div class="paragraph">
<p>A failure message consists of a two-byte failure code followed by the data applicable to that failure type.</p>
</div>
<div class="paragraph">
<p>The top byte of the failure_code is a set of binary flags that can be combined (with binary OR):</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">0x8000 (<code>BADONION</code>)</dt>
<dd>
<p>Unparsable onion encrypted by sending peer</p>
</dd>
<dt class="hdlist1">0x4000 (<code>PERM</code>)</dt>
<dd>
<p>Permanent failure (otherwise transient)</p>
</dd>
<dt class="hdlist1">0x2000 (<code>NODE</code>)</dt>
<dd>
<p>Node failure (otherwise channel)</p>
</dd>
<dt class="hdlist1">0x1000 (<code>UPDATE</code>)</dt>
<dd>
<p>New channel update enclosed</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The failure types shown in <a href="#failure_types_table">Onion error failure types</a> are currently defined.</p>
</div>
<table id="failure_types_table" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Onion error failure types</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Symbolic name</th>
<th class="tableblock halign-left valign-top">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PERM|1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">invalid_realm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>realm</code> byte was not understood by the processing node</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NODE|2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">temporary_node_failure</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">General temporary failure of the processing node</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PERM|NODE|2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">permanent_node_failure</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">General permanent failure of the processing node</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PERM|NODE|3</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">required_node_fea&amp;#x2060;ture_&amp;#x200b;missing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The processing node has a required feature which was not in this onion</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BADONION|PERM|4</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">invalid_onion_version</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>version</code> byte was not understood by the processing node</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BADONION|PERM|5</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">invalid_onion_hmac</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The HMAC of the onion was incorrect when it reached the processing node</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BADONION|PERM|6</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">invalid_onion_key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ephemeral key was unparsable by the processing node</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UPDATE|7</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">temporary_channel_&amp;#x200b;fail&amp;#x2060;ure</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The channel from the processing node was unable to handle this HTLC,
but may be able to handle it, or others, later</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PERM|8</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">permanent_channel_&amp;#x200b;fail&amp;#x2060;ure</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The channel from the processing node is unable to handle any HTLCs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PERM|9</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">required_channel_&amp;#x200b;fea&amp;#x2060;ture_missing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The channel from the processing node requires features not present in
the onion</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PERM|10</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">unknown_next_peer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The onion specified a <code>short_channel_id</code> which doesn&#8217;t match any
leading from the processing node</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UPDATE|11</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">amount_below_minimum</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The HTLC amount was below the <code>htlc_minimum_msat</code> of the channel from
the processing node</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UPDATE|12</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fee_insufficient</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The fee amount was below that required by the channel from the
processing node</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UPDATE|13</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">incorrect_cltv_expiry</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>cltv_expiry</code> does not comply with the <code>cltv_expiry_delta</code> required by
the channel from the processing node</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UPDATE|14</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">expiry_too_soon</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The CLTV expiry is too close to the current block height for safe
handling by the processing node</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PERM|15</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">incor&amp;#x2060;rect_or_unknown_&amp;#x200b;pay&amp;#x2060;ment_details</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>payment_hash</code> is unknown to the final node, the <code>payment_secret</code> doesn&#8217;t
match the <code>payment_hash</code>, the amount for that <code>payment_hash</code> is incorrect, or
the CLTV expiry of the HTLC is too close to the current block height for safe
handling</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>18</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">final_incor&amp;#x2060;rect_&amp;#x200b;cltv_expiry</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The CLTV expiry in the HTLC doesn&#8217;t match the value in the onion</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>19</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">final_incor&amp;#x2060;rect_&amp;#x200b;htlc_amount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The amount in the HTLC doesn&#8217;t match the value in the onion</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UPDATE|20</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">channel_disabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The channel from the processing node has been disabled</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>21</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">expiry_too_far</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The CLTV expiry in the HTLC is too far in the future</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PERM|22</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">invalid_onion_payload</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The decrypted onion per-hop payload was not understood by the processing node
or is incomplete</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>23</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mpp_timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The complete amount of the multipart payment was not received within a
reasonable time</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="stuck_payments">Stuck payments</h5>
<div class="paragraph">
<p>In the current implementation of the Lightning Network, there is a possibility that a payment attempt becomes <em>stuck</em>: neither fulfilled nor cancelled by an error. This can happen due to a bug on an intermediary node, a node going offline while handling HTLCs, or a malicious node holding HTLCs without reporting an error. In all of these cases, the HTLC cannot be resolved until it expires. The timelock (CLTV) that is set on every HTLC helps resolve this condition (among other possible HTLC routing and channel failures).</p>
</div>
<div class="paragraph">
<p>However, this means that the sender of the HTLC has to wait until expiry, and the funds committed to that HTLC remain unavailable until the HTLC expires. Furthermore, the sender <em>cannot retry</em> that same payment, because if they do, they run the risk of <em>both</em> the original and the retried payment succeedingthe recipient gets paid twice. This is because, once sent, an HTLC cannot be "cancelled" by the senderit either has to fail or expire. Stuck payments, while rare, create an unwanted user experience, where the user&#8217;s wallet cannot pay or cancel a payment.</p>
</div>
<div class="paragraph">
<p>One proposed solution to this problem is called <em>stuckless payments</em>, and it depends on Point Time-Locked Contracts (PTLCs), which are payment contracts that use a different cryptographic primitive than HTLCs (i.e., point addition on the elliptic curve instead of a hash and secret preimage). PTLCs are cumbersome using ECDSA but much easier with Bitcoin&#8217;s Taproot and Schnorr signature features, which were recently locked in for activation in November 2021. It is expected that PTLCs will be implemented in the Lightning Network after these Bitcoin features become activated.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="keysend">Keysend Spontaneous Payments</h3>
<div class="paragraph">
<p>In the payment flow described earlier in the chapter, we assumed that Dina
received an invoice from Alice "out of band," or obtained it via some mechanism
unrelated to the protocol (typically copy/paste or QR code scans). This trait
means that the payment process always takes two steps: first, the sender
obtains an invoice, and second, uses the payment hash (encoded in the invoice) to
successfully route an HTLC. The extra round trip required to obtain an invoice
before making a payment may be a bottleneck in applications that involve
streaming micropayments over Lightning. What if we could just "push" a payment
over spontaneously, without having to obtain an invoice from the recipient
first? The <code>keysend</code> protocol is an end-to-end extension (only the sender and
receiver are aware) to the Lightning protocol that enables spontaneous push
payments.</p>
</div>
<div class="sect3">
<h4 id="_custom_onion_tlv_records">Custom Onion TLV Records</h4>
<div class="paragraph">
<p>The modern Lightning protocol uses the TLV (Type-Length-Value) encoding in
the onion to encode information that tells each node <em>where</em> and <em>how</em> to
forward the payment. Leveraging the TLV format, each piece of routing information
(like the next node to which to pass the HTLC) is assigned a specific type (or key)
encoded as a <code>BigSize</code> variable length integer (max sized as as 64-bit
integer). These "essential" (reversed values below <code>65536</code>) types are defined
in BOLT #4, along with the rest of the onion routing details. Onion types with a
value greater than <code>65536</code> are intended to be used by wallets and applications
as "custom records."</p>
</div>
<div class="paragraph">
<p>Custom records allow payment applications to attach additional metadata or
context to a payment as key/value pairs in the onion. Since the custom records
are included in the onion payload itself, like all other hop contents, the
records are end-to-end encrypted. As the custom records effectively consume a
portion of the fixed-size 1300-bytes onion packet, encoding each key and
value of each custom record reduces the amount of available space for encoding
the rest of the route. In practice, this means that the more onion space used for custom records, the shorter the route can be. Given that each HTLC
packet is fixed size, custom records don&#8217;t <em>add</em> any additional data to an
HTLC; rather, they reallocate bytes that would have been filled with random data
otherwise.</p>
</div>
</div>
<div class="sect3">
<h4 id="_sending_and_receiving_keysend_payments">Sending and Receiving Keysend Payments</h4>
<div class="paragraph">
<p>A <code>keysend</code> payment inverts the typical flow of an HTLC where the receiver
reveals a secret preimage to the sender. Instead, the sender includes the
preimage <em>within</em> the onion to the receiver, and routes the HTLC to the
receiver. The receiver then decrypts the onion payload, and uses the included
preimage (which <em>must</em> match the payment hash of the HTLC) to settle the
payment. As a result, <code>keysend</code> payments can be carried out without first
obtaining an invoice from the receiver, as the preimage is "pushed" over to
the receiver. A <code>keysend</code> payment uses a TLV custom record type of <code>5482373484</code>
to encode a 32-byte preimage value.</p>
</div>
</div>
<div class="sect3">
<h4 id="_keysend_and_custom_records_in_lightning_applications">Keysend and Custom Records in Lightning Applications</h4>
<div class="paragraph">
<p>Many streaming Lightning applications use the <code>keysend</code> protocol to continually
stream satoshis to a destination identified by its public key in the network.
Typically, an application will also include metadata such as a
tipping/donation note or other application-level information in addition to
the <code>keysend</code> record.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph">
<p>The Lightning Network&#8217;s onion routing protocol is adapted from the Sphinx protocol to better serve the needs of a payment network. As such, it offers a huge improvement in privacy and counter-surveillance compared to the public and transparent Bitcoin blockchain.</p>
</div>
<div class="paragraph">
<p>In <a href="#path_finding">[path_finding]</a> we will see how the combination of source routing and onion routing is used by Alice to find a good path and route the payment to Dina. To find a path, Alice first needs to learn about the network topology, which is the topic of <a href="#gossip">[gossip]</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. George Danezis and Ian Goldberg, "Sphinx: A Compact and Provably Secure Mix Format," in <em>IEEE Symposium on Security and Privacy</em> (New York: IEEE, 2009), 269282.
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-05-27 12:12:12 -0400
</div>
</div>
</body>
</html>